#!/usr/bin/env bash

PHP_STAGED_FILES=$(git diff --name-only --cached --diff-filter=ACMR -- '*.php' | sed 's| |\\ |g')
TOOLS_PATH='./tools'
CMD=$1
shift 1

php_staged_files() {
  echo "$PHP_STAGED_FILES"
}

check_deps_vulnerabilities() {
  composer update --dry-run roave/security-advisories

  local STATUS=$?

  if [[ "$STATUS" -eq 0 ]]; then
    echo -e "\e[42mDependency vulnerability check is OK\e[m"
    return 0 # true
  fi
}

install_dependencies() {
  composer install --prefer-dist --no-progress
}

schema_create() {
    vendor/bin/doctrine \
    orm:schema-tool:create \
    --no-interaction
}

setup() {
  install_dependencies
  schema_create
}

phpunit() {
  ./vendor/bin/phpunit \
    --configuration "$TOOLS_PATH"/phpunit/phpunit.xml.dist \
    --exclude-group learning \
    --colors=always \
    --testdox \
    --verbose \
    "$@"
}

coverage() {
  export XDEBUG_MODE=coverage

  phpunit --coverage-text \
    --coverage-clover=.coverage/coverage-clover.xml \
    --coverage-html .coverage/html

  TEST_STATUS=$?

  export XDEBUG_MODE=off

  return $TEST_STATUS
}

psalm() {
  ./vendor/bin/psalm -c "$TOOLS_PATH"/psalm/psalm.xml --show-info=true --no-cache "$@"
}

coding_standard_fix() {

  #--stop-on-violation \

  ./vendor/bin/php-cs-fixer \
    fix \
    --verbose \
    --show-progress=dots \
    --cache-file="$TOOLS_PATH"/php-cs-fixer/.php-cs-fixer.cache \
    --config="$TOOLS_PATH"/php-cs-fixer/.php-cs-fixer.dist.php "$@"

#  return $?
}

while :; do
  case $CMD in
  install_dependencies)
    install_dependencies
    break
    ;;
  php_staged_files)
    php_staged_files
    break
    ;;
  setup)
    setup
    break
    ;;
  check-deps-vulnerabilities)
    check_deps_vulnerabilities
    break
    ;;
  schema-create)
    schema_create
    break;
    ;;
  phpunit)
    phpunit "$@"
    exit $?
    ;;
  coverage)
    coverage
    exit $?
    ;;
  psalm)
    psalm "$@"
    exit $?
    ;;
  psalm-taint)
    psalm --taint-analysis
    exit $?
    ;;
  type-coverage)
    psalm --shepherd
    exit $?
    ;;
  coding-standard-fix)
    coding_standard_fix "$@"
    exit $?
    ;;
  coding-standard-check)
    coding_standard_fix --dry-run "$@"
    exit $?
    ;;
  coding-standard-fix-all)
    coding_standard_fix ./src ./tests
    exit $?
    ;;
  coding-standard-fix-staged)
    coding_standard_fix $(git diff --name-only --cached --diff-filter=ACMR -- '*.php' | sed 's| |\\ |g')
    exit $?
    ;;
  coding-standard-check-staged)
    coding_standard_fix --dry-run $(git diff --name-only --cached --diff-filter=ACMR -- '*.php' | sed 's| |\\ |g')
    exit $?
    ;;
  coding-standard-check-all)
    coding_standard_fix --dry-run ./src ./tests
    exit $?
    ;;
  shortlist)
    echo \
      install_dependencies \
      php_staged_files \
      setup \
      check-deps-vulnerabilities \
      schema-create \
      phpunit \
      coverage \
      psalm \
      psalm-taint \
      type-coverage \
      coding-standard-fix \
      coding-standard-fix-all \
      coding-standard-fix-staged \
      coding-standard-check-staged \
      coding-standard-check-all
    break
    ;;
  esac
done
